name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - master
      - develop

jobs:
  pr-validation:
    name: Validate PR Changes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest
      
      - name: Run tests
        run: |
          pytest test_validator.py -v
      
      - name: Get changed files in PR
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **/*.yaml
            **/*.yml
            **/*.json
            **/*.tf
            docker-compose*.yml
            docker-compose*.yaml
            compose.yml
            compose.yaml
      
      - name: Validate changed config files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ðŸ” Validating changed configuration files..."
          echo ""
          echo "Changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n'
          echo ""
          
          failed=0
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [ -f "$file" ]; then
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ðŸ“„ Validating: $file"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              if python validator.py "$file"; then
                echo "âœ… $file - Validation passed"
              else
                echo "âŒ $file - Validation failed"
                failed=1
              fi
              echo ""
            fi
          done
          
          if [ $failed -eq 1 ]; then
            echo "âŒ Some configuration files failed validation!"
            exit 1
          else
            echo "âœ… All configuration files passed validation!"
          fi
      
      - name: Comment PR with validation results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            let comment = '## ðŸ” Configuration File Validation Results\n\n';
            
            try {
              // Get changed files
              const changedFiles = `${{ steps.changed-files.outputs.all_changed_files }}`.split(' ').filter(f => f);
              
              if (changedFiles.length === 0) {
                comment += 'âœ… No configuration files were changed in this PR.\n';
              } else {
                comment += `### Files Validated:\n`;
                changedFiles.forEach(file => {
                  comment += `- \`${file}\`\n`;
                });
                comment += '\n';
                
                // Try to validate and report
                let allPassed = true;
                changedFiles.forEach(file => {
                  try {
                    execSync(`python validator.py "${file}"`, { stdio: 'pipe' });
                    comment += `âœ… \`${file}\` - Passed\n`;
                  } catch (error) {
                    allPassed = false;
                    comment += `âŒ \`${file}\` - Failed\n`;
                  }
                });
                
                if (allPassed) {
                  comment += '\nâœ… **All configuration files passed validation!**\n';
                } else {
                  comment += '\nâŒ **Some configuration files failed validation. Please check the logs above.**\n';
                }
              }
            } catch (error) {
              comment += `âš ï¸ Error during validation: ${error.message}\n`;
            }
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('Configuration File Validation Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

