name: Config File Validator CI

on:
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - '**.yaml'
      - '**.yml'
      - '**.json'
      - '**.tf'
      - 'docker-compose*.yml'
      - 'docker-compose*.yaml'
      - 'compose.yml'
      - 'compose.yaml'
      - 'validator.py'
      - 'test_*.py'
      - 'requirements.txt'
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - '**.yaml'
      - '**.yml'
      - '**.json'
      - '**.tf'
      - 'docker-compose*.yml'
      - 'docker-compose*.yaml'
      - 'compose.yml'
      - 'compose.yaml'
      - 'validator.py'
      - 'test_*.py'
      - 'requirements.txt'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run tests with pytest
        run: |
          pytest test_validator.py -v --cov=validator --cov-report=xml --cov-report=term
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  validate-configs:
    name: Validate Config Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **/*.yaml
            **/*.yml
            **/*.json
            **/*.tf
            docker-compose*.yml
            docker-compose*.yaml
            compose.yml
            compose.yaml
      
      - name: Validate changed config files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
          
          # Validate each changed file
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              python validator.py "$file" || exit 1
            fi
          done
      
      - name: Validate all config files in repository
        if: github.event_name == 'push'
        run: |
          echo "Validating all config files in repository..."
          find . -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.json" -o -name "*.tf" -o -name "docker-compose*.yml" -o -name "docker-compose*.yaml" -o -name "compose.yml" -o -name "compose.yaml" \) \
            ! -path "./.git/*" \
            ! -path "./.github/*" \
            ! -path "./__pycache__/*" \
            ! -path "./.pytest_cache/*" \
            ! -path "./venv/*" \
            ! -path "./env/*" \
            -exec python validator.py {} \; || exit 1

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint black isort
      
      - name: Run flake8
        run: |
          flake8 validator.py test_validator.py --max-line-length=120 --extend-ignore=E203,W503 || true
      
      - name: Run pylint
        run: |
          pylint validator.py test_validator.py --max-line-length=120 --disable=C0111 || true
      
      - name: Check code formatting with black
        run: |
          black --check --line-length=120 validator.py test_validator.py || true
      
      - name: Check import sorting with isort
        run: |
          isort --check-only validator.py test_validator.py || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit safety
      
      - name: Run Bandit security scan
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . || true
      
      - name: Check for known security vulnerabilities
        run: |
          safety check --json || true
          safety check || true

  validate-examples:
    name: Validate Example Configs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create example configs for validation
        run: |
          mkdir -p examples
          
          # Create example Docker Compose file
          cat > examples/docker-compose.example.yml << 'EOF'
          version: '3.8'
          services:
            web:
              image: nginx:latest
              ports:
                - "80:80"
            db:
              image: postgres:13
              environment:
                POSTGRES_DB: mydb
          EOF
          
          # Create example Kubernetes manifest
          cat > examples/k8s-pod.example.yaml << 'EOF'
          apiVersion: v1
          kind: Pod
          metadata:
            name: example-pod
          spec:
            containers:
              - name: nginx
                image: nginx:latest
          EOF
          
          # Create example Terraform file
          cat > examples/main.example.tf << 'EOF'
          resource "aws_instance" "example" {
            ami           = "ami-12345678"
            instance_type = "t2.micro"
            
            tags = {
              Name = "ExampleInstance"
            }
          }
          EOF
          
          # Create example JSON config
          cat > examples/config.example.json << 'EOF'
          {
            "name": "example",
            "version": "1.0.0",
            "settings": {
              "debug": false,
              "port": 8080
            }
          }
          EOF
      
      - name: Validate example configs
        run: |
          python validator.py examples/ || exit 1

